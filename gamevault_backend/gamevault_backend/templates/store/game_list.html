{% extends 'base.html' %}
{% load static %}

{% block title %}Games - GameVault{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/marketplace.css' %}">
<link rel="stylesheet" href="{% static 'css/modules/animations.css' %}">
{% endblock %}

{% block content %}
<div class="marketplace-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <!-- Background Slideshow -->
        <div class="hero-slideshow">
            {% if featured_games %}
                {% for game in featured_games %}
                    <div class="hero-slide {% if forloop.first %}active{% endif %}" style="background-image: url('{{ game.screenshot_url }}');"></div>
                {% endfor %}
            {% else %}
                <!-- Fallback gradient if no games with screenshots -->
                <div class="hero-slide active" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            {% endif %}
        </div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="hero-title">Game Vault: Digital Keys Shop</h1>
            <p class="hero-subtitle">Instant delivery • Secure payment • Lowest Price</p>
        </div>
    </div>

    <!-- Search Bar Section -->
    <div class="search-section">
        <form method="get" class="search-form">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" name="search" placeholder="Search for games..." value="{{ search_query }}" class="search-input">
                <button type="submit" class="search-btn">Search</button>
            </div>
        </form>
    </div>

    <!-- Filter and Sort Bar -->
    <div class="filter-bar">
        <form method="get" class="filter-form-inline">
            <input type="hidden" name="search" value="{{ search_query }}">
            
            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select name="category" class="filter-select-compact" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Price Range</label>
                <div class="price-inputs">
                    <input type="number" name="min_price" placeholder="Min" step="0.01" value="{{ min_price }}" class="price-input">
                    <span class="price-separator">-</span>
                    <input type="number" name="max_price" placeholder="Max" step="0.01" value="{{ max_price }}" class="price-input">
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Sort By</label>
                <select name="sort" class="filter-select-compact" onchange="this.form.submit()">
                    <option value="">Relevance</option>
                    <option value="price_low" {% if selected_sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_high" {% if selected_sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                    <option value="newest" {% if selected_sort == 'newest' %}selected{% endif %}>Newest First</option>
                    <option value="oldest" {% if selected_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
                </select>
            </div>

            <div class="filter-group filter-group-tags">
                <label class="filter-label">Tags</label>
                <div class="tags-dropdown">
                    <button type="button" class="tags-dropdown-toggle" onclick="toggleTagsDropdown(event)">
                        <span class="tags-selected-text">
                            {% if selected_tags %}
                                {{ selected_tags|length }} tag{{ selected_tags|length|pluralize }} selected
                            {% else %}
                                Select tags...
                            {% endif %}
                        </span>
                        <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div class="tags-dropdown-menu">
                        <div class="tags-search-wrapper">
                            <input type="text" class="tags-search-input" placeholder="Search tags..." onkeyup="filterTags(this)">
                        </div>
                        <div class="tags-options-list">
                            {% for tag in tags %}
                                <label class="tag-option">
                                    <input type="checkbox" name="tags" value="{{ tag.id }}"
                                        {% if tag.id|stringformat:"s" in selected_tags %}checked{% endif %}>
                                    <span class="tag-option-text">{{ tag.name }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="filter-apply-btn">Apply Filters</button>
            <a href="{% url 'store:game_list' %}" class="filter-clear-btn">Clear All</a>
        </form>
    </div>


    {% if filter_type == 'tag' %}
        <p class="filter-info">Showing games tagged with: <strong>{{ filter_value }}</strong></p>
    {% elif filter_type == 'category' %}
        <p class="filter-info">Showing games in category: <strong>{{ filter_value }}</strong></p>
    {% endif %}


    <!-- Results Count -->
    <div class="results-info">
        <p class="results-count">Showing {{ games|length }} game{{ games|length|pluralize }}</p>
    </div>

    <!-- Game Cards Grid -->
    <div class="games-grid">
        {% for game in games %}
            <div class="game-card-modern">
                <a href="{% url 'store:game_detail' game.id %}" class="game-card-link">
                    <div class="game-card-image">
                        {% if game.screenshot_url %}
                            <img src="{{ game.screenshot_url }}" alt="{{ game.title }}" loading="lazy">
                        {% else %}
                            <div class="game-image-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                                    <polyline points="17 2 12 7 7 2"></polyline>
                                </svg>
                            </div>
                        {% endif %}
                        <div class="game-badge">{{ game.category }}</div>
                    </div>
                    
                    <div class="game-card-body">
                        <h3 class="game-card-title">{{ game.title }}</h3>
                        <p class="game-card-description">{{ game.description|truncatewords:15 }}</p>
                        
                        <div class="game-card-footer">
                            <div class="game-price-section">
                                {% if game.has_promotion %}
                                    <div class="price-with-discount">
                                        <div class="discount-row">
                                            <span class="game-price-value discounted">${{ game.discounted_price|floatformat:2 }}</span>
                                            <span class="discount-badge">{{ game.discount_label }}</span>
                                        </div>
                                        <span class="original-price">${{ game.price }}</span>
                                    </div>
                                {% else %}
                                    <span class="game-price-label">From</span>
                                    <span class="game-price-value">${{ game.price }}</span>
                                {% endif %}
                            </div>
                            <div class="game-card-actions">
                                {% if user.is_authenticated %}
                                    <form method="post" action="{% url 'store:add_to_cart' game.id %}" class="add-cart-form" onclick="event.stopPropagation();">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-add-cart">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="9" cy="21" r="1"></circle>
                                                <circle cx="20" cy="21" r="1"></circle>
                                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                            </svg>
                                            Add to Cart
                                        </button>
                                    </form>
                                {% else %}
                                    <a href="{% url 'users:login' %}" class="btn-view-details" onclick="event.stopPropagation();">View Details</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
                {% if user.is_authenticated %}
                <button
                    class="btn-wishlist {% if game.id in wishlist_game_ids %}active{% endif %}"
                    data-game-id="{{ game.id }}"
                    title="{% if game.id in wishlist_game_ids %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}"
                    onclick="event.stopPropagation(); toggleWishlist(this);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                         fill="{% if game.id in wishlist_game_ids %}currentColor{% else %}none{% endif %}"
                         stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>
                {% endif %}
            </div>
        {% empty %}
            <div class="no-results">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <h3>No games found</h3>
                <p>Try adjusting your search or filters to find what you're looking for.</p>
                <a href="{% url 'store:game_list' %}" class="btn-reset">Clear Filters</a>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!--{{ block.super }}-->

<script>
// Fetch API for wishlist
async function toggleWishlist(button) {
    const gameId = button.getAttribute('data-game-id');
    const isActive = button.classList.contains('active');
    const svg = button.querySelector('svg');

    // Use the correct API endpoints
    const url = isActive
        ? `/store/api/wishlist/${gameId}/`  // DELETE
        : `/store/api/wishlist/`;           // POST

    try {
        const response = await fetch(url, {
            method: isActive ? 'DELETE' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: isActive ? null : JSON.stringify({ game: gameId }),
        });

        if (response.ok) {
            // Toggle button and SVG fill
            button.classList.toggle('active');
            svg.setAttribute('fill', isActive ? 'none' : 'currentColor');

            // Toast message
            showMessage(isActive ? "Removed from wishlist" : "Added to wishlist", "success");
            console.log(isActive ? 'Removed from wishlist' : 'Added to wishlist');

        } else {
            // Attempt to parse JSON error
            let data = {};
            try {
                data = await response.json();
            } catch (e) {
                console.warn("Response was not JSON", e);
            }
            console.warn('Wishlist update failed:', data);
            showMessage("Error updating wishlist", "error");

            // Handle already-in-wishlist edge case gracefully
            if (data && data.detail && data.detail.includes("already in your wishlist")) {
                button.classList.add('active');
                svg.setAttribute('fill', 'currentColor');
            }
        }
    } catch (error) {
        console.error('Wishlist update error:', error);
        showMessage("Error updating wishlist", "error");
    }
}

// CSRF helper
function getCSRFToken() {
    const name = 'csrftoken=';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name)) {
            return cookie.substring(name.length);
        }
    }
    return '';
}

// Temporary feedback function
function showFeedback(message, type) {
    alert(message);
}

// Hero Slideshow Auto-rotation
document.addEventListener('DOMContentLoaded', function() {
    const slides = document.querySelectorAll('.hero-slide');
    
    if (slides.length > 1) {
        let currentSlide = 0;
        
        function nextSlide() {
            // Remove active class from current slide
            slides[currentSlide].classList.remove('active');
            
            // Move to next slide (loop back to 0 if at end)
            currentSlide = (currentSlide + 1) % slides.length;
            
            // Add active class to new slide
            slides[currentSlide].classList.add('active');
        }
        
        // Change slide every 5 seconds
        setInterval(nextSlide, 5000);
    }
});

// Tags Dropdown Functions
function toggleTagsDropdown(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropdown = event.currentTarget.parentElement;
    const menu = dropdown.querySelector('.tags-dropdown-menu');
    const isOpen = menu.classList.contains('show');
    
    // Close all other dropdowns
    document.querySelectorAll('.tags-dropdown-menu.show').forEach(m => {
        if (m !== menu) m.classList.remove('show');
    });
    
    // Toggle current dropdown
    menu.classList.toggle('show');
    
    // Close dropdown when clicking outside
    if (!isOpen) {
        setTimeout(() => {
            document.addEventListener('click', closeTagsDropdown);
        }, 0);
    }
}

function closeTagsDropdown(event) {
    const dropdowns = document.querySelectorAll('.tags-dropdown-menu.show');
    dropdowns.forEach(menu => {
        if (!menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
            menu.classList.remove('show');
        }
    });
    document.removeEventListener('click', closeTagsDropdown);
}

function filterTags(input) {
    const searchText = input.value.toLowerCase();
    const options = input.closest('.tags-dropdown-menu').querySelectorAll('.tag-option');
    
    options.forEach(option => {
        const text = option.querySelector('.tag-option-text').textContent.toLowerCase();
        if (text.includes(searchText)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });
}

// Update selected count when checkboxes change
document.addEventListener('DOMContentLoaded', function() {
    const tagCheckboxes = document.querySelectorAll('.tag-option input[type="checkbox"]');
    tagCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedTagsCount);
    });
});

function updateSelectedTagsCount() {
    const checkedBoxes = document.querySelectorAll('.tag-option input[type="checkbox"]:checked');
    const selectedText = document.querySelector('.tags-selected-text');
    
    if (checkedBoxes.length > 0) {
        selectedText.textContent = `${checkedBoxes.length} tag${checkedBoxes.length > 1 ? 's' : ''} selected`;
    } else {
        selectedText.textContent = 'Select tags...';
    }
}

</script>
{% endblock %}
