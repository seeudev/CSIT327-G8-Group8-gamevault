{% extends 'base.html' %}
{% load static %}

{% block title %}{{ game.title }} - GameVault{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/game-detail.css' %}">
<link rel="stylesheet" href="{% static 'css/modules/animations.css' %}">
<link rel="stylesheet" href="{% static 'css/modules/ai-consensus.css' %}">
{% endblock %}

{% block content %}
<div class="game-detail-modern">
    <div class="game-detail-hero">
        <div class="game-hero-image">
            {% if game.screenshot_url %}
                <img src="{{ game.screenshot_url }}" alt="{{ game.title }}" id="gameHeroImage">
                <div class="hero-overlay"></div>
            {% else %}
                <div class="hero-placeholder">
                    <svg width="120" height="120" fill="rgba(255,255,255,0.3)">
                        <path d="M60 10 L90 40 L90 90 L30 90 L30 40 Z M45 50 L75 50 L75 60 L45 60 Z M45 70 L75 70 L75 80 L45 80 Z"/>
                    </svg>
                </div>
                <div class="hero-overlay"></div>
            {% endif %}
        </div>

        <div class="game-hero-content">
            <div class="breadcrumb">
                <a href="{% url 'store:game_list' %}">← Back to Store</a>
            </div>
            <h1 class="game-title-hero">{{ game.title }}</h1>
            <div class="game-meta">
                <span class="meta-badge category-badge">{{ game.category }}</span>
                <span class="meta-badge">{{ game.upload_date|date:"F d, Y" }}</span>
            </div>
        </div>
    </div>

    <div class="game-detail-content">
        <div class="game-main-section">
            <!-- Tags Section -->
            {% if game.tags.all.count > 0 %}
            <div class="game-tags-card card-interactive">
                <h3 class="tags-title">Tags</h3>
                <div class="tags-container">
                    {% for tag in game.tags.all %}
                        <a href="{% url 'store:games_by_tag' tag.id %}" class="tag-badge">{{ tag.name }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="game-description-card card-interactive">
                <h2 class="section-title">About This Game</h2>
                <p class="game-description-text">{{ game.description }}</p>
            </div>

            <div class="game-features-card card-interactive">
                <h2 class="section-title">Game Details</h2>
                <div class="features-grid">
                    <div class="feature-item">
                        <div class="feature-icon icon-gamepad"></div>
                        <div class="feature-content">
                            <span class="feature-label">Category</span>
                            <span class="feature-value">{{ game.category }}</span>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon icon-calendar"></div>
                        <div class="feature-content">
                            <span class="feature-label">Date Added</span>
                            <span class="feature-value">{{ game.upload_date|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Market Analysis Section (Module 17) -->
            <div class="ai-consensus-section card-interactive" id="aiConsensusSection">
                <div class="consensus-header">
                    <h2 class="section-title">
                        <span class="ai-badge">AI</span> Market Analysis
                    </h2>
                    {% if user.is_admin %}
                    <button onclick="refreshConsensus()" class="btn-refresh-ai" id="refreshBtn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Refresh
                    </button>
                    {% endif %}
                </div>
                
                <div id="consensusLoading" class="consensus-loading">
                    <div class="loading-spinner-sm"></div>
                    <span>Analyzing market data...</span>
                </div>
                
                <div id="consensusContent" class="consensus-content" style="display: none;">
                    <!-- Consensus Matrix -->
                    <div class="consensus-matrix">
                        <div class="sentiment-card local-sentiment">
                            <h3>Local Buyers</h3>
                            <div class="sentiment-score" id="localScore">--</div>
                            <div class="sentiment-label">Based on <span id="localCount">0</span> reviews</div>
                            <div class="sentiment-bar">
                                <div class="sentiment-fill local-fill" id="localBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="sentiment-vs">VS</div>
                        
                        <div class="sentiment-card global-sentiment">
                            <h3>Global Web</h3>
                            <div class="sentiment-score" id="globalScore">--</div>
                            <div class="sentiment-label" id="globalLabel">External sources</div>
                            <div class="sentiment-bar">
                                <div class="sentiment-fill global-fill" id="globalBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Verdict -->
                    <div class="ai-verdict" id="aiVerdict">
                        <h3>AI Verdict</h3>
                        <p id="verdictText">Loading analysis...</p>
                    </div>
                    
                    <!-- Verified Sources -->
                    <div class="verified-sources" id="verifiedSources" style="display: none;">
                        <h3>Verified External Sources</h3>
                        <div class="sources-grid" id="sourcesGrid"></div>
                    </div>
                    
                    <div class="consensus-disclaimer">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        AI analysis synthesizes local reviews with real-time web data. Sources verified via Google Search.
                    </div>
                </div>
                
                <div id="consensusError" class="consensus-error" style="display: none;">
                    <p>Unable to load AI analysis at this time.</p>
                </div>
            </div>
            
            <!-- Reviews Section (Module 11) -->
            <div class="reviews-section card-interactive">
                <div class="reviews-header">
                    <h2 class="section-title">Ratings & Reviews</h2>
                    <div class="rating-summary" id="ratingSummary">
                        <div class="average-rating">
                            <div class="rating-number">--</div>
                            <div class="rating-stars" id="averageStars"></div>
                            <div class="rating-count"><span id="reviewCount">0</span> reviews</div>
                        </div>
                    </div>
                </div>
                
                <!-- Review Form -->
                {% if user.is_authenticated %}
                <div class="review-form-container" id="reviewFormContainer">
                    <h3>Write a Review</h3>
                    <form id="reviewForm" class="review-form">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="form-label">Your Rating</label>
                            <div class="star-rating-input" id="starRatingInput">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <input type="hidden" id="ratingValue" name="rating" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="reviewText">Your Review (Optional)</label>
                            <textarea id="reviewText" name="review_text" class="form-textarea" rows="4" placeholder="Share your thoughts about this game..."></textarea>
                        </div>
                        <button type="submit" class="btn-submit-review">Submit Review</button>
                    </form>
                </div>
                {% else %}
                <div class="login-prompt">
                    <p><a href="{% url 'users:login' %}">Login</a> to write a review</p>
                </div>
                {% endif %}
                
                <!-- Reviews List -->
                <div class="reviews-list" id="reviewsList">
                    <div class="loading-reviews">Loading reviews...</div>
                </div>
            </div>
        </div>

        <aside class="game-sidebar">
            <div class="purchase-card card-interactive">
                <div class="price-section">
                    <span class="price-label">Price</span>
                    {% if game.has_promotion %}
                        <div class="price-discount-wrapper">
                            <span class="discount-badge-detail">{{ game.discount_label }}</span>
                            <span class="price-value price-discounted">${{ game.discounted_price|floatformat:2 }}</span>
                            <span class="price-original">${{ game.price|floatformat:2 }}</span>
                            <span class="savings-text">Save ${{ game.savings_amount|floatformat:2 }}</span>
                        </div>
                    {% else %}
                        <span class="price-value">${{ game.price|floatformat:2 }}</span>
                    {% endif %}
                </div>

                <div class="purchase-actions">
                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'store:add_to_cart' game.id %}" class="add-cart-form-detail">
                            {% csrf_token %}
                            <button type="submit" class="btn-purchase">
                                <span class="btn-icon icon-cart"></span>
                                Add to Cart
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'users:login' %}" class="btn-purchase">
                            <span class="btn-icon icon-lock"></span>
                            Login to Purchase
                        </a>
                    {% endif %}
                </div>

                <div class="purchase-info">
                    <div class="info-item">
                        <svg width="16" height="16" fill="currentColor"><path d="M8 0 L10 6 L16 6 L11 10 L13 16 L8 12 L3 16 L5 10 L0 6 L6 6 Z"/></svg>
                        <span>Instant delivery</span>
                    </div>
                    <div class="info-item">
                        <svg width="16" height="16" fill="currentColor"><path d="M8 0 L10 6 L16 6 L11 10 L13 16 L8 12 L3 16 L5 10 L0 6 L6 6 Z"/></svg>
                        <span>Lowest Price</span>
                    </div>
                </div>
            </div>
                </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/game-detail.js' %}"></script>
<script src="{% static 'js/reviews.js' %}"></script>
<script src="{% static 'js/ai-consensus.js' %}"></script>
<script>
    const gameId = {{ game.id }};
    const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
    
    // Initialize reviews and AI consensus when page loads
    document.addEventListener('DOMContentLoaded', function() {
        ReviewSystem.init(gameId, isAuthenticated);
        AIConsensus.init(gameId);
    });
</script>
{% endblock %}
