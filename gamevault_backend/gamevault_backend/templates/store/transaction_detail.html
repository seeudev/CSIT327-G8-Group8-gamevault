{% extends 'base.html' %}
{% load static %}

{% block title %}Order Details - GameVault{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/transactions.css' %}">
<link rel="stylesheet" href="{% static 'css/modules/animations.css' %}">
{% endblock %}

{% block content %}
<div class="transaction-detail-modern">
    <div class="detail-header-card">
        <nav class="breadcrumb-nav">
            <a href="{% url 'store:transaction_history' %}" class="breadcrumb-link">← Back to Transaction History</a>
        </nav>
        <h1 class="detail-title">
            <span class="title-icon">📦</span>
            Order #{{ transaction.id }}
        </h1>
        
        <div class="detail-meta">
            <div class="meta-item">
                <span class="meta-label">📅 Order Date</span>
                <span class="meta-value">{{ transaction.transaction_date|date:"F d, Y" }}</span>
                <span class="meta-date">{{ transaction.transaction_date|date:"h:i A" }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">📊 Status</span>
                <span class="meta-value">
                    <span class="status-badge-large status-{{ transaction.payment_status }}">
                        <span class="status-icon">{% if transaction.payment_status == 'completed' %}✓{% elif transaction.payment_status == 'pending' %}⏳{% else %}✗{% endif %}</span>
                        {{ transaction.get_payment_status_display }}
                    </span>
                </span>
            </div>
            <div class="meta-item">
                <span class="meta-label">🎮 Total Items</span>
                <span class="meta-value">{{ transaction_items|length }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">💰 Total Amount</span>
                <span class="meta-value" style="color:var(--color-primary)">${{ transaction.total_amount }}</span>
            </div>
        </div>
    </div>
    
    <div class="games-section">
        <h2 class="section-title-detail">
            <span>🎮</span>
            Your Games
        </h2>
        
        <div class="games-grid-detail">
            {% for item in transaction_items %}
                <div class="game-item-card" data-item-id="{{ item.id }}">
                    <div class="game-item-header">
                        <div class="game-info-section">
                            <h3 class="game-title-detail">{{ item.game.title }}</h3>
                            <p class="game-category-detail">{{ item.game.category|default:"Digital Game" }}</p>
                        </div>
                        <span class="game-price-detail">${{ item.price_at_purchase }}</span>
                    </div>
                    
                    {% if item.game_key %}
                        <div class="game-key-section">
                            <div class="key-label">🔑 Activation Key</div>
                            <div class="game-key-modern">
                                <code class="key-code" id="key-{{ item.id }}">{{ item.game_key }}</code>
                                <button class="btn-copy-key" onclick="copyKey('{{ item.game_key }}', {{ item.id }})" title="Copy key">
                                    📋 Copy
                                </button>
                            </div>
                            {% if item.key_sent_at %}
                                <div class="key-status-detail">
                                    ✅ Key sent to {{ user.email }} on {{ item.key_sent_at|date:"M d, Y" }}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <div class="game-actions">
                        {% if item.game.file_url %}
                            <a href="{% url 'store:download_game' transaction.id item.game.id %}" class="btn-action btn-download">
                                ⬇️ Download Game
                            </a>
                        {% else %}
                            <button class="btn-action" disabled>
                                Download Unavailable
                            </button>
                        {% endif %}
                        
                        <button 
                            class="btn-action btn-email {% if item.key_sent_at %}sending{% endif %}"
                            data-item-id="{{ item.id }}"
                            data-transaction-id="{{ transaction.id }}"
                            onclick="sendKey(this)"
                            {% if item.key_sent_at %}disabled{% endif %}>
                            {% if item.key_sent_at %}✅ Key Sent{% else %}📧 Email Key{% endif %}
                        </button>
                    </div>
                    
                    <div class="status-message" id="status-{{ item.id }}"></div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'js/transaction-detail.js' %}"></script>
{% endblock %}
{% endblock %}
